<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>DTMF â†’ ã‚«ã‚¿ã‚«ãƒŠé€†å¤‰æ›</title>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f8f8f8; text-align: center; }
    input, button { font-size: 1.2em; margin: 1em; }
    #result { font-size: 1.4em; margin-top: 1.5em; }
  </style>
</head>
<body>
  <h1>ğŸ” DTMFéŸ³å£° â†’ ã‚«ã‚¿ã‚«ãƒŠå¤‰æ›</h1>
  <input type="file" accept="audio/wav" id="audioFile" /><br>
  <button onclick="analyzeDTMF()">è§£æé–‹å§‹</button>
  <div id="result">çµæœ: ã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹</div>

  <script>
    const dtmfFreqs = {
      "1": [697, 1209], "2": [697, 1336], "3": [697, 1477],
      "4": [770, 1209], "5": [770, 1336], "6": [770, 1477],
      "7": [852, 1209], "8": [852, 1336], "9": [852, 1477],
      "*": [941, 1209], "0": [941, 1336], "#": [941, 1477]
    };

    const numberToKana = {
      "11": "ã‚¢", "12": "ã‚¤", "13": "ã‚¦", "14": "ã‚«", "15": "ã‚­", "16": "ã‚¯",
      "17": "ã‚µ", "18": "ã‚·", "19": "ã‚¹",
      "21": "ã‚¿", "22": "ãƒ", "23": "ãƒ„", "24": "ãƒŠ", "25": "ãƒ‹", "26": "ãƒŒ",
      "27": "ãƒ", "28": "ãƒ’", "29": "ãƒ•",
      "31": "ãƒ", "32": "ãƒŸ", "33": "ãƒ ", "34": "ãƒ¤", "35": "", "36": "ãƒ¦",
      "37": "ãƒ©", "38": "ãƒ¬", "39": "",
      "41": "ãƒ¡", "42": "ãƒ¢", "43": "ã‚›", "44": "ãƒ¯", "45": "ãƒ¼",
      "46": "ã‚œ", "47": "ãƒ²", "48": "ãƒ³", "49": "å°"
    };

    const tolerance = 20;

    function matchTone(f1, f2) {
      for (let k in dtmfFreqs) {
        const [a, b] = dtmfFreqs[k];
        if (
          (Math.abs(a - f1) < tolerance && Math.abs(b - f2) < tolerance) ||
          (Math.abs(b - f1) < tolerance && Math.abs(a - f2) < tolerance)
        ) return k;
      }
      return "?";
    }

    async function analyzeDTMF() {
      const file = document.getElementById('audioFile').files[0];
      if (!file) return alert("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«é¸ã‚“ã§");

      const arrayBuffer = await file.arrayBuffer();
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const buffer = await ctx.decodeAudioData(arrayBuffer);

      const channel = buffer.getChannelData(0);
      const sampleRate = buffer.sampleRate;

      const frameSize = Math.floor(0.1 * sampleRate); // 100ms
      const detectedTones = [];

      for (let i = 0; i < channel.length; i += frameSize) {
        const frame = channel.slice(i, i + frameSize);
        const fft = new Float32Array(frameSize);
        for (let j = 0; j < frame.length; j++) {
          fft[j] = frame[j] * Math.hammingWindow(j, frame.length); // çª“é–¢æ•°
        }

        const spectrum = getFFT(fft, sampleRate);
        const peaks = findPeaks(spectrum, 2); // ä¸Šä½2å€‹

        if (peaks.length === 2) {
          const tone = matchTone(peaks[0].freq, peaks[1].freq);
          if (tone !== "?") detectedTones.push(tone);
        }
      }

      const pairs = [];
      for (let i = 0; i < detectedTones.length - 1; i += 2) {
        const pair = detectedTones[i] + detectedTones[i + 1];
        pairs.push(pair);
      }

      const kana = pairs.map(p => numberToKana[p] || "ï¼Ÿ").join("");
      document.getElementById("result").textContent = `çµæœ: ${kana}ï¼ˆ${pairs.join(" ")}ï¼‰`;
    }

    // ç°¡æ˜“FFTãƒ”ãƒ¼ã‚¯æŠ½å‡º
    function getFFT(data, sampleRate) {
      const len = data.length;
      const spectrum = [];
      for (let k = 1; k < len / 2; k++) {
        let re = 0, im = 0;
        for (let n = 0; n < len; n++) {
          const phase = (2 * Math.PI * k * n) / len;
          re += data[n] * Math.cos(phase);
          im -= data[n] * Math.sin(phase);
        }
        const mag = Math.sqrt(re * re + im * im);
        spectrum.push({ freq: k * sampleRate / len, mag });
      }
      return spectrum;
    }

    function findPeaks(spectrum, count) {
      return spectrum.sort((a, b) => b.mag - a.mag).slice(0, count);
    }

    // çª“é–¢æ•°
    Math.hammingWindow = (i, N) => 0.54 - 0.46 * Math.cos((2 * Math.PI * i) / (N - 1));
  </script>
</body>
</html>
